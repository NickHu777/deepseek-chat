services:
  deepseek-dev-postgres:
    image: ankane/pgvector:pg15
    container_name: deepseek-dev-postgres
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: chat_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes: 
      - postgres_dev_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - deepseek-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  deepseek-postgres:
    image: ankane/pgvector:pg15
    container_name: deepseek-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment: 
      POSTGRES_DB: chat_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    networks:
      - deepseek-network
    healthcheck: 
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

deepseek-fastapi:
  build: .
  container_name: deepseek-fastapi
  restart: unless-stopped
  ports:
    - "8000:8000"
  environment:
    ENV: ${ENV:-development}
    DEBUG: ${DEBUG:-true}
    DB_HOST: ${DB_HOST:-deepseek-postgres}
    DB_PORT: ${DB_PORT:-5432}
    DB_NAME: ${DB_NAME:-chat_db}
    DB_USER: ${DB_USER:-postgres}
    DB_PASSWORD: ${DB_PASSWORD:-postgres}
    DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}

    # 新增向量配置
    VECTOR_MODEL: ${VECTOR_MODEL:-all-MiniLM-L6-v2}
    EMBEDDING_DIMENSION: ${EMBEDDING_DIMENSION:-384}
    UPLOAD_DIR: ${UPLOAD_DIR:-/app/uploads}
    MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
    ALLOWED_EXTENSIONS: ${ALLOWED_EXTENSIONS:-.pdf,.docx,.doc,.txt,.md,.csv,.xlsx,.xls,.json}
    CHUNK_SIZE: ${CHUNK_SIZE:-1000}
    CHUNK_OVERLAP: ${CHUNK_OVERLAP:-200}
    SIMILARITY_THRESHOLD: ${SIMILARITY_THRESHOLD:-0.7}
    SEARCH_LIMIT: ${SEARCH_LIMIT:-5}
    ENABLE_ASYNC_PROCESSING: ${ENABLE_ASYNC_PROCESSING:-true}
  volumes:
    - ./uploads:/app/uploads  # 添加上传目录映射
  depends_on:
    deepseek-postgres:
      condition: service_healthy
  networks:
    - deepseek-network

volumes:
  postgres_dev_data:
    driver: local
  postgres_prod_data:
    driver: local

networks:
  deepseek-network:
    driver: bridge
